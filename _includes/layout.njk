<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ title or site.title }}</title>

    <link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap&subset=cyrillic,cyrillic-ext,latin">
    <link rel="stylesheet" href="/assets/style.css">
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
  </head>
  <body>
    <header class="container">
  <div class="site-header" data-pagefind-ignore>
    <div class="site-header__logo">
      <a href="/" aria-label="На главную">
        <img src="/assets/logo.png" alt="PHG" height="150">
      </a>
    </div>

    <div class="site-header__title">
      <div class="site-title"><a href="/intro2/">{{ site.title }}</a></div>
      <div class="tagline">{{ site.tagline }}</div>
    </div>
  </div>
      <nav class="chapters-horizontal">
        <ul>
          <li class="menu-group">
            <span><a href="/intro1">Введения</a></span>
            <ul class="submenu">
              <li><a href="/intro1">К изданию 1994 г.</a></li>
              <li><a href="/intro2">К изданию 1951 г.</a></li>
            </ul>
          </li>

          <li class="menu-group">
            <span><a href="/v1ch1/">Том 1</a></span>
            <ul class="submenu">
              {% if collections.chaptersByVolume and collections.chaptersByVolume[1] %}
                {% for ch in collections.chaptersByVolume[1] %}
                  <li><a href="{{ ch.url }}">{{ ch.data.menuTitle or ch.data.title or ch.fileSlug }}</a></li>
                {% endfor %}
              {% else %}
                <li><em>Пока нет глав</em></li>
              {% endif %}
            </ul>
          </li>

          <li class="menu-group">
            <span><a href="/v2ch1/">Том 2</a></span>
            <ul class="submenu">
              {% if collections.chaptersByVolume and collections.chaptersByVolume[2] %}
                {% for ch in collections.chaptersByVolume[2] %}
                  <li><a href="{{ ch.url }}">{{ ch.data.menuTitle or ch.data.title or ch.fileSlug }}</a></li>
                {% endfor %}
              {% else %}
                <li><em>Пока нет глав</em></li>
              {% endif %}
            </ul>
          </li>

          <li class="menu-group">
            <span><a href="/about">О проекте</a></span>
            {# <ul class="submenu">
              <li><a href="/glossary">Глоссарий</a></li>
              <li><a href="/about">О проекте</a></li>
              <li><a href="/gttl">GTTL</a></li>#}
            </ul>
          </li>
        </ul>
      </nav>
    <div class="site-header__search">
      <div id="search" class="search"></div>
      <div id="search-results" class="search-results"></div>
    </div>
    </header>

    <main class="container content" data-pagefind-body>
      {# =========================
   AUTO PREV / NEXT (ТОЛЬКО ДЛЯ ГЛАВ)
   Требует в frontmatter:
     type: chapter
     volume: 1 или 2
   ========================= #}

{% set isChapter = (type == "chapter") %}
{% if isChapter and collections.chaptersByVolume and collections.chaptersByVolume[volume] %}
  {% set list = collections.chaptersByVolume[volume] %}
  {% set prev = null %}
  {% set next = null %}
  {% set last = null %}
  {% set found = false %}

  {# Ищем prev/next по совпадению URL #}
  {% for ch in list %}
    {% if not found %}
      {% if ch.url == page.url %}
        {% set prev = last %}
        {% set found = true %}
      {% else %}
        {% set last = ch %}
      {% endif %}
    {% else %}
      {% if not next %}
        {% set next = ch %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if isChapter and found %}
<div class="parallel-nav-grid">
  <div class="nav-ru">
    {% if prev %}
      <a class="chapter-nav-link" href="{{ prev.url }}">← {{ prev.data.title }}</a>
    {% endif %}
  </div>

  <div class="nav-en">
    

    {% if next %}
      <a class="chapter-nav-link" href="{{ next.url }}">{{ next.data.title }} →</a>
    {% endif %}
  </div>
</div>
{% endif %}
{% endif %}
        {# Листалка сверху — “над серой областью” (контентом) #}
        {# {% if found %}
          <div class="parallel-nav-grid" data-parallel-nav>
  <div class="nav-ru">
    <!-- prev -->
  </div>

  <div class="nav-en">
  <!-- next -->
    <button class="parallel-toggle" type="button" data-parallel-toggle>Скрыть оригинал ×</button>
    
  </div>
</div>
        {% endif %} #}

      {# ====== ВАЖНО: КОНТЕНТ ВСЕГДА РЕНДЕРИТСЯ ====== #}
      {{ content | safe }}

      <hr>

      <section class="disclaimer" data-pagefind-ignore>
        <p>{{ site.disclaimer_en }}</p>
        <p>{{ site.disclaimer_ru }}</p>
      </section>

      <section class="comments">
        {# Giscus (если включишь — раскомментируешь и заполнишь атрибуты) #}
      </section>
    </main>

    <footer class="container footer" data-pagefind-ignore>
      <p>© GTTL Translators, 2025 · Research & Educational Use Only</p>
    </footer>

    <script async src="https://hypothes.is/embed.js"></script>

   <script>
document.addEventListener("DOMContentLoaded", function () {
  // 1) Переносим parallel-nav-grid внутрь .parallel-block (перед .parallel-controls)
  const nav = document.querySelector(".parallel-nav-grid");
  const block = document.querySelector(".parallel-block");

  if (nav && block) {
    const controls = block.querySelector(".parallel-controls");
    if (controls) {
      block.insertBefore(nav, controls);
    } else {
      block.prepend(nav);
    }
  }

  // 2) Тоггл скрытия оригинала (для каждого parallel-block)
  document.querySelectorAll(".parallel-block").forEach((block) => {
    const btn = block.querySelector("[data-parallel-toggle]");
    if (!btn) return;

    btn.addEventListener("click", () => {
      const closed = block.classList.toggle("parallel-closed");
      btn.textContent = closed ? "Показать оригинал" : "Скрыть оригинал ×";
    });
  });
});
</script>
<script type="module">
document.addEventListener("DOMContentLoaded", async () => {
  const resultsEl = document.querySelector("#search-results");
  const inputHost = document.querySelector("#search");
  if (!resultsEl || !inputHost) return;

  const mod = await import("/pagefind/pagefind.js");
  const pagefind = mod.default ?? mod;   // <-- ВАЖНО
  if (pagefind.init) await pagefind.init();

  inputHost.innerHTML = `
    <input class="search-input" type="search" placeholder="Поиск по тексту…" />
  `;
  const input = inputHost.querySelector("input");

  let last = 0;

  async function run(q) {
    const stamp = ++last;
    q = (q || "").trim();
    resultsEl.innerHTML = q ? `<div class="search-status">Ищу: ${q}</div>` : "";
    if (!q) return;

    const r = await pagefind.search(q);
    if (stamp !== last) return;

    const pages = await Promise.all(
      (r.results || []).slice(0, 20).map((res) => res.data())
    );

    resultsEl.innerHTML = pages.map((p) => {
      const volume = p.meta?.volume || "";
      const chapter = p.meta?.chapter || p.title || "";
      const excerpt = p.excerpt || "";
      const anchor = p.anchors?.[0]?.id ? `#${p.anchors[0].id}` : "";
      const url = (p.url || "") + anchor;

      return `
        <article class="search-card">
          <div class="search-meta">
            <span class="search-volume">${volume}</span>
            <span class="search-sep">·</span>
            <span class="search-chapter">${chapter}</span>
          </div>
          <a class="search-link" href="${url}">
            <div class="search-excerpt">${excerpt}</div>
          </a>
        </article>
      `;
    }).join("");
  }

  let t;
  input.addEventListener("input", () => {
    clearTimeout(t);
    t = setTimeout(() => run(input.value), 150);
  });
});
</script>
  </body>
</html>
